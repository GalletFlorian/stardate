\section{Method}
\label{section:method}

We fit a broken power law to the 650 Myr Praesepe cluster in order to
calibrate a new gyrochronology relation that takes advantage of new data
available from the \ktwo\ and \gaia\ surveys.
Praesepe is the ideal calibration cluster because it has the largest number of
members with precisely measured rotation periods, over a large range of
colors, of any open cluster.
It is relatively tightly clustered on the sky and many of its members were
targeted in a single \ktwo\ campaign, from which rotation periods have been
measured via light curve frequency analysis \citep{douglas2017, rebull2017}.
We compiled rotation periods, \Gaia\ photometry and \gaia\ parallaxes for
members of the 650 Myr Praesepe cluster \citep{fossati2008} by identifying
Praesepe members with measured rotation periods from \citet{douglas2017} in
the \ktwo-\gaia\ crossmatch catalog provided at
\url{https://gaia-kepler.fun/}.
This catalog cross-matched the EPIC catalog \citep{huber2016} with with the
Gaia DR2 catalog \citep{brown2018}, using a 1'' search radius.
The result was a sample of 757 stars with rotation periods, parallaxes and
\gaia\ $G$, $G_{BP}$ and $G_{RP}$-band photometry, shown in figure
\ref{fig:praesepe}\footnote{This analysis was performed in a Jupyter notebook
available here: \url{
    https://github.com/RuthAngus/stardate/blob/master/paper/code/Praesepe.ipynb}}.
Although this new model does not perfectly describe the rotation period of
every star, it provides a better representation of rotational evolution than
previous models such as the \citet{angus2015} model (as shown in figure
\ref{fig:praesepe}).
\begin{figure}
  \caption{
    The rotation periods of Praesepe members \citep{douglas2016},
    vs. their \Gaia\ colors (\gcolor) with a broken power law model, fit to
    these data.
    The dashed line and shaded region shows the mean and variance model
    described in equation \ref{eqn:gyro} at 650 Myrs (lower model) and 4.56
    Gyrs (upper model).
    The solid blue line shows the \citep{angus2015} gyrochronology relation at
    650 Myrs (lower model) and 4.56 Gyrs (upper model).
    Shaded regions show the 1$\sigma$ range of the log-normal rotation period
    model.
    The rotation periods of stars bluer than around 0.56 dex and redder than
    around 2.7 dex in \gcolor\ are modelled as a broad log-normal distribution
    with a standard deviation of 0.5 dex, added to observational
    uncertainties.
    This figure was generated in a Jupyter notebook available at
    \url{https://github.com/RuthAngus/stardate/blob/master/paper/code/Fitting_Praesepe.ipynb}
}
  \centering
    \includegraphics[width=1.1\textwidth]{Praesepe.pdf}
\label{fig:praesepe}
\end{figure}
In order to fit a relation to Praesepe, we removed rotational outliers bluer
than \gcolor\ = 2.7 via sigma-clipping and fit a 5th-order polynomial to the
remaining FGK and early M stars.
We also fit a straight line to the late M dwarfs (\gcolor\ $>$ 2.7).
We fit a separable straight line function to the period-age relation using
the ages of Praesepe and the Sun\footnote{The fitting process was
performed in a Jupyter notebook available at
\url{https://github.com/RuthAngus/stardate/blob/master/paper/code/Fitting_Praesepe.ipynb}.}.
This new Praesepe-calibrated gyrochronology relation is,
% \begin{equation}
%     \log_{10}(P_\mathrm{rot}) = f(\log_{10}[A])g(\log_{10}[G_{BP}-G_{RP}]) \nonumber,
% \end{equation}
\begin{equation}
    \log_{10}(P_\mathrm{rot}) =
    c_A\log_{10}(A) +
    \sum_{n=0}^4 c_n[\log_{10}(G_{BP}-G_{RP})]^n
    % 0.65(0.05)\log_{10}(A) -4.7(0.5) + 0.72(0.05)C
    % -4.9(0.2)C^2 + 29(2)C^3 -38(3)C^4
\label{eqn:fgk_gyro}
\end{equation}
% where C is $\log_{10}(G_{BP}-G_{RP})$, $A$ is age in years, and parameter
% uncertainties are parenthesized,
for stars with \gcolor\ $<$ 2.7 and
% \begin{equation}
%     P_{\mathrm{rot}} = f(A)h(C) \nonumber,
% \end{equation}
\begin{equation}
    \log_{10}(P_\mathrm{rot}) =
    c_A\log_{10}(A) +
    \sum_{m=0}^1 b_m[\log_{10}(G_{BP}-G_{RP})]^m
    % \log_{10}(P_{rot}) = 0.65(0.05)\log_{10}(A) + 0.9(0.5) -13.6(0.1)C,
\label{eqn:m_gyro}
\end{equation}
for stars with \gcolor\ $>$ 2.7, where $P_{\mathrm{rot}}$ is rotation period
in days and $A$ is age in years.
Best-fit coefficient values are shown in table \ref{tab:coefficients}.
\begin{table}[h!]
  \begin{center}
      \caption{Coefficient values for equations \ref{eqn:fgk_gyro} and
      \ref{eqn:m_gyro}.}
    \label{tab:coefficients}
    \begin{tabular}{l|c} % <-- Alignments: 1st column left and 2nd middle, with vertical lines in between
      Coefficient & Value  \\
      \hline
      $c_A$ & 0.65 $\pm$ 0.05 \\
      $c_0$ & -4.7 $\pm$ 0.5 \\
      $c_1$ & 0.72 $\pm$ 0.05 \\
      $c_2$ & -4.9 $\pm$ 0.2 \\
      $c_3$ & 29 $\pm$ 2 \\
      $c_4$ & -38 $\pm$ 4 \\
      $b_0$ & 0.9 $\pm$ 0.5 \\
      $b_1$ & -13.6 $\pm$ 0.1 \\
    \end{tabular}
  \end{center}
\end{table}

\racomment{
We calibrated a new relation using Praesepe and the Sun alone,
without including other clusters, because different open clusters have
slightly different period-color relationships \citep{agueros2018,
agueros2018b, curtis2018} and, given that we use an age-color separable
relation, adding in extra clusters is unlikely to improve the calibration in
this format.
We also did not include asteroseismic stars because they are slightly evolved
and, since this gyrochronology relation does not include $\log g$, they are
therefore not useful calibrators.
This new relation, fit to Praesepe and the Sun, does not perfectly predict the
rotation periods of stars at all colors and ages, but it provides several
improvements over previous empirical gyrochronology relations.
Firstly, it uses new \ktwo\ rotation period measurements to model the
period-color relation of Praesepe in detail, secondly, it includes a model for
the rotational behavior of M dwarfs, and thirdly, it is calibrated to \Gaia\
\gcolor\ color: a directly observable quantity and the most widely available
photometric color index.
Equation \ref{eqn:fgk_gyro} describes the rotational evolution of stars with
Sun-like magnetic dynamos.
These are stars that follow the \citet{skumanich1972} magnetic braking law,
\ie\ their rotation period increases with the square root of their age.
It does not describe stars hotter than around 6250 K which have a thin
convective layers and a weak magnetic dynamo, nor does it describe fully
convective stars which take a long time to converge onto the
\citet{skumanich1972} braking law.
In addition, stars with Rossby numbers larger than around 2 do not show
Skumanich-like magnetic braking \citep{vansaders2016, vansaders2018}, so
equation \ref{eqn:fgk_gyro} does not describe these stars.
It also does not describe the rotation periods of subgiants or giants, whose
rotation periods are influenced by their expanding radii, changing winds, and
core-to-surface differential rotation \citep[\eg][]{vansaders2013, tayar2018}.
Finally, this relation does not describe the rotation periods of dynamically
or magnetically interacting binaries.
Binaries often rotate more rapidly than isolated stars at the same age and
color \citep{douglas2016}.

In order to include non-Skumanich type stars in our combined gyrochronal and
isochronal model, we designed a composite gyrochronology relation which
describes a mean and variance model for the rotation period distributions
across the HRD.
Rotation periods are modeled differently for stars of different photometric
color, EEP, Rossby number, age and metallicity.
The rotation period model for each of these groups is described below.
\begin{itemize}
    \item{The rotation periods of late F, GK, and early M dwarfs are modeled
        as a log-normal distribution, with mean given by equation
        \ref{eqn:fgk_gyro}, and variance given by the squared inverse of the
        observational uncertainties.}
    \item{The rotation periods of stars hotter than around 6250 K are
        modeled with a log-normal distribution with mean,
        $\log_{10}(P_\mathrm{rot})=0.56$, and an extra standard deviation
        of 0.5 dex, added to observational uncertainties.
        This model for the mean and variance of hot star rotation periods is
        based on stars hotter than 6250 K in the \citet{mcquillan2014} sample,
        which have a mean $\log_{10}(P_\mathrm{rot})$ of 0.56 dex and a
        standard deviation of around 0.5 dex.}
    \item{The rotation periods of fully convective stars are modeled with a
         log-normal distribution with mean given by equation \ref{eqn:m_gyro},
         and additional standard deviation of 0.5 dex.
         This distribution reflects the observed rotation periods  of late M
        dwarfs in the Praesepe cluster.}
    % \item{Rotation period measurements of asteroseismic stars suggest that
    %     stellar rotation periods stop evolving when stars reach a maximum
    %     Rossby number of 2 \citep{vansaders2016, vansaders2018}.
    %     After this, stars maintain a constant rotation period of
    %     $P_\mathrm{max} = 2/\tau$, where $\tau$ is the convective turnover
    %     timescale, until they become subgiants.
    \item{The age at which a star's Rossby number would exceed 2 is calculated
        for each star by inverting equation \ref{eqn:fgk_gyro}.
        If a star's age is greater than this, its mean rotation period is
        given by $P_\mathrm{max} = 2/\tau$, where $\tau$ is the convective
        turnover timescale, calculated using equation 11 from
        \citet{wright2011}.}
        % We included this newly characterized behavior in our composite
        % gyrochronology model.}
    \item{The rotation periods of subgiants are described with a log-normal
        distribution with mean given by equation \ref{eqn:fgk_gyro},
        \ref{eqn:m_gyro} or 0.56, depending on its color, and an additional
        standard deviation of 0.5 dex.
        This is not strictly an accurate model of subgiant rotation periods
        \citep[see, \eg][]{vansaders2013} but, because of the inflated
        variance, it is a weakly constraining one.
        Isochrone fitting provides precise ages for subgiants, so by inflating
        the variance of the gyrochronology relation at large EEP, we allow a
        star's position on the HRD/CMD to dominate the age information over
        its rotation period.}
    \item{We model stars younger than around 250 Myrs with a log-normal
        distribution with mean function given by \ref{eqn:fgk_gyro},
        \ref{eqn:m_gyro} or 0.56, depending on it whether it has
        an intermediate, blue or red color, respectively and a inflated
        standard deviation of 0.5 dex.
        Rotation periods in young open clusters show a large amount of scatter
        because they have not yet converged onto the \citet{skumanich1972}
        spin-down sequence.}
    \item{Finally, we model stars with very low and high metallicites (-3 $<$
        [Fe/H] $<$ 3) with a log-normal distribution with mean given by
        \ref{eqn:fgk_gyro}, \ref{eqn:m_gyro} or 0.56, depending on its color,
        and a standard deviation of 0.5 dex.
        Gyrochronology is not calibrated at these extreme metallicities due to
        a lack of suitable metal poor and rich calibration stars.
        Rather than assume the same gyrochronology model can be na\"ively
        applied to these stars, we take a more conservative approach and model
        them with a broad Gaussian distribution.}
\end{itemize}
Inflating the variance of the rotation period distribtion for stars with
non-Skumanich magnetic braking behavior has two purposes: 1) in the cases of
hot stars and fully convective stars, it allows the broad distributions of
rotation periods observed in clusters and the field to be matched, and 2) it
down-weights the age-information provided by rotation periods in regions of
the HRD/CMD where rotation periods are not information-rich or the
gyrochronology model is inaccurate or uncalibrated.
If the observational uncertainties on rotation periods are 10\% on average,
which corresponds to 0.1/$\ln(10)$ $\sim$ 0.0434 dex, adding 0.5 to this is
a 12.5$\times$ increase in standard deviation, or a 156$\times$ increase in
variance.
The variance on stellar ages inferred via gyrochronology is directly
proportional to the variance on rotation periods, so a 12.5$\times$ increase
in period standard deviation corresponds to a 12.5$\times$ reduction in the
age-information provide by gyrochronology and a 12.5$\times$ increase in
gyrochronal age uncertainty.
So, practically speaking, when the standard deviation is inflated to 0.5 dex,
ages are almost entirely inferred via isochrone fitting.
}

We used the following composite gyrochronology model to infer ages from
rotation periods,
\begin{equation}
    \log_{10}(P_\mathrm{rot}) \sim \begin{cases}
        \mathcal{N}\left[(\ref{eqn:fgk_gyro}), (\sigma+\sigma_P)^2\right], & Ro < 2,
        G_{BP} - G_{RP} < 2.7 \\
        \mathcal{N}[(\ref{eqn:m_gyro}), (\sigma+\sigma_P)^2], & Ro < 2,
        G_{BP} - G_{RP} > 2.7 \\
        \mathcal{N}[\log_{10}(P_\mathrm{max}), (\sigma+\sigma_P)^2],& Ro \geq 2 \\
        \mathcal{N}[0.56, (\sigma+\sigma_P)^2],& G_{BP} - G_{RP} < 0.56,
    \end{cases}
\label{eqn:gyro}
\end{equation}
where $\sigma$ is the relative period uncertainty, divided by $\ln(10)$, on
individual rotation period measurements and $\sigma_P$ is an additional
scatter that is a function of EEP, age, metallicity and color.
It takes a maximal value of 0.5 for hot stars, fully convective stars,
subgiants and giants and a minimal value of zero for late F, GK and early M
dwarfs.
The variance model is shown in figure \ref{fig:variance}.
% This additional scatter is described in more detail later in this section.
% This gyrochronology model reflects the observed ceasing of magnetic braking at
% a critical Rossby number of around 2 \citep{vansaders2016}.
% The Rossby number, $Ro$, is the ratio of rotation period to convective
% overturn time $P_{\mathrm{rot}}/\tau$.
% It determines whether a star is still undergoing magnetic braking ($Ro < 2$)
% or has stopped spinning down, in which case it retains its terminal rotation
% period of $P_\mathrm{max} = 2\tau$ \citep{vansaders2016}.
% We estimated the convective overturn time, $\tau$, using equation 11 of
% \citet{wright2011}.
% The rotation periods of hot stars (\gcolor\ $<$ 0.56) are fast and do
% not relate to their age or color.
% We modeled these stars with a simple log-normal distribution with a mean of
% 3.5 days, based on the rotation periods of hot stars in the
% \citet{mcquillan2014} catalog.

% PIXIE
% The rotation periods of hot stars, cool stars, subgiants and giants evolve
% differently to FGK and early M dwarfs.
% Stars more massive than around 1.25 M$_\odot$, with a temperature $\gtrsim$
% 6250 K and a $B-V$ color $\lesssim$ 0.45 do not spin down appreciably over
% their main sequence lifetimes because they do not have the deep convective
% envelope needed to generate strong magnetic fields.
% Late M dwarfs with masses $\lesssim$ 0.3 M$_\odot$, temperatures $\lesssim$
% 3500 and $B-V$ $\gtrsim$ 1.4 do not start magnetic braking until at least
% after the age of Praesepe ($\sim$650 million years).
The rotation periods of hot stars, cool stars, subgiants and giants evolve
differently to FGK and early M dwarfs.
Stars more massive than around 1.25 M$_\odot$, with a temperature $\gtrsim$
6250 K and a \gcolor\ color $\lesssim$ 0.56 do not spin down appreciably over
their main-sequence lifetimes because they do not have the deep convective
envelope needed to generate strong magnetic fields.
Late M dwarfs with masses $\lesssim$ 0.3 M$_\odot$, temperatures $\lesssim$
3500 and \gcolor $\gtrsim$ 2.7 are only weakly magnetically braking until at
least after the age of Praesepe ($\sim$650 million years).
Both hot and cool stars retain rotation periods that are similar to their
primordial distribution \citep[see \eg][]{matt2012, somers2017}.
Finally, the rotation periods of evolved stars slow dramatically as their
radii grow.
% Although the rotation periods of hot, cool, and evolved stars are less
% age-informative than late F, GK and early M dwarfs, they still improve age
% measurement precision and accuracy by refining CMD/HRD placement.
We designed a model describing the rotation period variance of hot, cool and
evolved stars, inflating the variance to high values in regions of parameter
space where the simple gyrochronology power law does not apply or where
rotation periods become stochastic.
% In order to reflect the stochastic rotation periods of hot and cool stars,
% and `switch off' gyrochronology, just using isochrone fitting for
% the hot, cool and evolved stars, we designed a model describing the rotation
% period variance of these stars, inflating the variance to high values in
% regions of parameter space where gyrochronology does not apply.
The variance model was designed to reflect the observed distributions of hot,
cool and evolved stars and naturally reduce the amount of age-information
provided by gyrochronology for stars where the rotation period is
uninformative.
In parts of the CMD/HRD where rotation periods are stochastic, isochronal
information dominates and ages are predominantly inferred via isochrone
fitting.
We used three sigmoid functions to increase the (log) rotation period variance
% as a function of $B-V$ and EEP, shown in figure \ref{fig:variance}.
as a function of \gcolor\ and EEP, shown in figure \ref{fig:variance}.
The additional variance was zero where gyrochronology works well: for late F,
GK and early M dwarfs and 0.25 ($\sigma = 0.5$) for hot, cool and evolved
stars.
The logistic functions shown in figure \ref{fig:variance} reach half their
% PIXIE maximum values at 0.45, 1.4 and 454 for hot stars, cool stars and
% subgiants,
maximum values at \gcolor\ = 0.56 and 2.5 for hot and cool stars respectively
and EEP = 454 for subgiants.
The maximum standard deviation value of the logarithmic rotation periods for
all three groups (hot, cool and evolved) was 0.5 and the logistic growth rate,
or steepness, of the three sigmoids were 100 dex$^-1$, 100 dex$^-1$ and
.2 in EEP$^-1$ for hot, cool and evolved stars respectively.
If a star is both hot and evolved, the additional standard deviation of its
rotation period rises to 1 (no late M dwarfs have yet evolved off the main
sequence so this does not apply to the cool stars).
\begin{figure}
  \caption{
    The additional rotation period scatter, $\sigma_P$, added to the
    observational period uncertainties in the model (see equation
    \ref{eqn:gyro}).
    The standard deviation was increased for early F and hotter
    % stars ($B-V < 0.45$), late M dwarfs ($B-V > 1.4$) and evolved stars
    stars (\gcolor $<$ 0.56), late M dwarfs (\gcolor\ $>$ 2.7) and evolved
    stars (EEP $>$ 454) in order to down-weight the age-information supplied
    by rotation periods and reproduce observed rotation period distributions.
    We also increased the variance for stars younger than around 250 Myrs,
    because the rotation periods of these stars typically have not yet
    converged onto a tight gyrochronology sequence.
    The variance was also increased for very high and low metallicity stars
    (-3 $\lesssim$ [Fe/H] $\lesssim$ 3) because the gyrochronology relations
    have not been calibrated at these extreme values.
    Down-weighting the gyrochronal likelihood by the inverse variance
    ($1/\sigma^2$) allows the ages of these stars to be mostly inferred
    via isochrone fitting.
    The variance of an inferred age is proportional to the
    variance of the rotation periods.
    Adding 0.25 to the variance of the (log) rotation periods is an increase
    over the variance provided by period measurement uncertainties of around
    a factor of 100.
    By increasing the variance 100-fold, we reduce the age-information in
    rotation periods by 100-fold.
    The ages of hot and evolved stars can be relatively precisely constrained
    with isochrone fitting since their position on the CMD changes rapidly
    with time, however isochrone fitting cannot constrain the ages of
    % late M dwarfs, so the age of any star with $B-V > 1.4$ will not be
    late M dwarfs, so the age of any star with \gcolor\ $\gtrsim$ 2.5 will not
    be precisely constrained with \sd.
}
  \centering
    \includegraphics[width=1.\textwidth]{variance}
\label{fig:variance}
\end{figure}

% %   - Introduction
% % In this section we describe the combined isochrone fitting and gyrochronology
% % model implemented in \sd, as well as the inference process.
% % A common approach to stellar age-dating is to make separate age predictions
% % using separate sets of observables.
% % For example, if a star's rotation period, parallax, and apparent magnitudes in
% % a range of bandpasses are available, it is possible to predict its age from
% % both gyrochronology and isochrone fitting separately.
% % How these two age predictions are later combined is then a difficult choice.
% % Is it best to average these predictions, to use the more precise of the two,
% % or the one believed to be more accurate?
% % The methodology described here provides an objective method for combining age
% % estimates.
% % There is, after all, only one age for each star.
% Combining information from different models can be relatively simple as long
% as the processes that generated the data are independent.
% In this case, we are combining observables that relate to the burning of
% hydrogen in the core
% % (this is the process that drives the slow increase in \teff\ and luminosity
% % over time)
% with observables relating to the magnetic braking history of a star (the
% current rotation period)
% and we can assume that, to first order, these two processes are independent.
% % These processes are not truly independent, however any dependence here is
% % unlikely to affect our results within the uncertainties.
% If this assumption is valid, the likelihoods calculated using each model can
% be multiplied together.

Our goal was to infer the age of a star from its observable properties by
estimating the posterior probability density function (PDF) over age,
\begin{equation} \label{eqn:eqn1}
    % p(A|{\bf m_x}, T_{\mathrm{eff}}, \log(g), \hat{F},
    p(A|{\bf m_x}, P_{\mathrm{rot}}, \bar{\omega}),
\end{equation}
where $A$ is age, ${\bf m_x}$ is a vector of
apparent magnitudes in various bandpasses,
% \fhat\ is the {\it observed} bulk metallicity,
\prot\ is the rotation period and \pmega\ is parallax.
Spectroscopic properties (\teff, \logg\ and $\hat{\mathrm{Fe/H}}$) and/or
asteroseismic parameters (\dnu\ and \numax) may also be available for a star,
in which case they would appear to the right of the `$|$' in the above
equation since they are observables.
In order to calculate a posterior PDF over age, other stellar parameters must
be marginalized over.
These parameters are distance ($D$), V-band extinction ($A_V$), the
inferred metallicity, $F$\footnote{The inferred metallicity is a
model parameter which is different to the {\it observed} metallicity which
would appear on the right side of the $`|'$ in equation \ref{eqn:eqn1}.},
and equivalent evolutionary point (abbreviated to EEP or
$E$).
EEP is a dimensionless number ranging from around 200 for M dwarfs up
to around 800 for subgiants and is 355 for the Sun \citep[see][]{dotter2016,
choi2016}.
Stars are defined as subgiants when their EEP exceeds 454.
Mass is uniquely defined by EEP, age and metallicity.
The marginalization involves integrating over these extra parameters,
\begin{eqnarray} \label{eqn:bayes}
    % & p(A|{\bf m_x}, T_{\mathrm{eff}}, \log(g), \hat{F},
    & p(A|{\bf m_x},
    P_{\mathrm{rot}}, \bar{\omega})
\\ \nonumber
    % & \propto \int p({\bf m_x}, T_{\mathrm{eff}}, \log(g), \hat{F},
    & \propto \int p({\bf m_x},
    P_\mathrm{rot}, \bar{\omega}|
    A, E, F, D, A_V)~p(A)p(E)p(F)p(D)p(A_V)dEdFdDdA_V.
\end{eqnarray}
This equation is a form of Bayes' rule,
\begin{equation} \label{eqn:eqn2}
\mathrm{Posterior} \propto \mathrm{Likelihood} \times \mathrm{Prior},
\end{equation}
where the likelihood of the data given the model is,
\begin{equation} \label{eqn:full_likelihood}
    % p({\bf m_x}, T_{\mathrm{eff}}, \log(g), \hat{F}, \bar{\omega},
    p({\bf m_x}, \bar{\omega}, P_{\mathrm{rot}}|A, E, D, A_V, F),
\end{equation}
and the prior PDF over parameters is,
\begin{equation} \label{eqn:prior}
    p(A)p(E)p(D)p(A_V)p(F).
\end{equation}
The priors we used are described in the appendix.

% %   - Why iso and gyro are independent.
% Not all of the observables on the left of the `$|$' in the likelihood depend
% on all of the parameters to the right of it.
% For example, rotation period, \prot\ does not depend on V-band extinction,
% $A_V$.
% In our model, we make use of conditional independencies like this and use them
% to factorize the likelihood.
% Instead of the likelihood of equation \ref{eqn:full_likelihood},
% where every observable depends on every parameter, our model can be factorized
% as,
% \begin{equation} \label{eqn:factorized}
%     p({\bf m_x}, T_{\mathrm{eff}}, \log(g), \hat{F}, \bar{\omega}
%     |D, A_V, F, A, E) ~p(P_\mathrm{rot}|A, E, F).
% \end{equation}
% where we have introduced two new parameters, $C_{B-V}$, which is the $B-V$
% color that is often used as a mass proxy in the literature and mass itself
% ($M$), which is used in our gyrochronology model to calculate convective
% turnover time and therefore Rossby number.
% The above factorization of the likelihood describes the fact that, in our
% model EEP, age, metallicity, extinction and distance determine the observed
% spectroscopic properties (\teff, \logg, \feh) and apparant magnitudes, ${\bf
% m_x}$) as well as the \cbv\ color and mass of a star.
% In turn, it is a star's age, \cbv\ color, mass and EEP that determine its
% rotation period.
% Breaking up the problem this way allows us to easily combine isochronology and
% gyrochronology and infer the joint age of a star from all its observables.
% While true that rotation period also depends on metallicity at some level, we
% assume that this dependency is weak enough not to significantly affect the
% ages that we infer.

% $C_{B-V}$ and $M$ are not measured but {\it inferred}: they are latent
% parameters.
% We infer $C_{B-V}$ because many stars do not have a directly measured $B-V$
% color.
% For example, most \kepler\ stars have {\it 2MASS} photometry in J, H and K
% bands and \Gaia\ photometry in $G$, $G_{BP}$ and $G_{RP}$, but do not all have
% B and V band colors.
% However, the gyrochronology model we use is calibrated to B-V color, not J-K
% or otherwise \citep{barnes2007, mamajek2008, angus2015}.
% % A probabilistic graphical model (PGM) depicting the joint probability over
% % parameters and observables is shown in figure \ref{fig:PGM}.
% % It describes the conditional dependencies between parameters (in white
% % circles) and observables (in grey circles) with arrows leading from the causal
% % processes to the dependent processes.
% For example, it is the mass, age, metallicity, extinction and distance that
% determines the observed spectroscopic properties (\teff, \logg, \feh)
% and apparant magnitudes, ${\bf m_x}$).
% These parameters also determine the \cbv\ color of a star.
% In turn, it is a star's age and \cbv\ color that determine its rotation
% period.
% Note that, written this way, stellar rotation periods do not directly depend
% on stellar mass.
% Mass, age and metallicity determine $C_{B-V}$, and $C_{B-V}$ along with age
% determines rotation period.
% The purpose of this PGM is not to depict the physical realities of stellar
% evolution, it is only a visual description of the structure of the model we
% use here.
% Breaking up the problem this way allows us to efficiently join isochronology
% and gyrochronology and infer the joint age of a star from all its observables.
% It may well be that rotation period depends directly on mass and metallicity
% in reality, but it is more practical for us to assume that these dependencies
% are weak enough not to significantly affect the ages that we ultimately infer.

%   - The formulas The factorization of the likelihood described in equation
%   \ref{eqn:factorized}
The assumption of independence allowed us to multiply two separate likelihood
functions together: one computed using an isochronal model and one computed
using a gyrochronal model.
We assumed that the probability of observing the measured observables, given
the model parameters was a Gaussian and that the observables were identically
and independently distributed.
The isochronal likelihood function was,
\begin{eqnarray} \label{eqn:isochrones_only_likelihood}
    % & \mathcal{L_{\mathrm{iso}}} = p({\bf m_x}, T_{\mathrm{eff}}, \log(g),
    & \mathcal{L_{\mathrm{iso}}} = p({\bf m_x},
    \bar{\omega}|A, E, F, D,
    A_V) \\ \nonumber
    & = \frac{1}{\sqrt{(2\pi)^n \det(\Sigma)}}
    \exp\left( -\frac{1}{2} ({\bf O_I} - {\bf I})^T \Sigma ^{-1}
    ({\bf O_I} - {\bf I})\right),
\end{eqnarray}
where ${\bf O_I}$ is the vector of observables: \pmega, ${\bf m_x}$ plus
spectroscopic and/or asteroseismic observables if available, and $\Sigma$ is
the covariance matrix of that set of observables.
${\bf I}$ is the vector of {\it model} observables that correspond to a set of
parameters: $A$, $E$, $F$, $D$ and $A_V$, calculated using an isochrone model.
We assumed there is no covariance between these observables and so this
covariance matrix consists of individual parameter variances along the
diagonal with zeros everywhere else.
The gyrochronal likelihood function was,
\begin{eqnarray} \label{eqn:gyro_likelihood}
    % & \mathcal{L_{\mathrm{gyro}}} = p(P_\mathrm{rot} |A, C_{B-V}, M) \\ \nonumber
    & \mathcal{L_{\mathrm{gyro}}} = p(P_\mathrm{rot} |A, E, F, D, A_V) \\ \nonumber
    & = \frac{1}{\sqrt{(2\pi) \det(\Sigma_P)}}
    \exp\left( -\frac{1}{2} ({\bf P_O} - {\bf P_P})^T \Sigma ^{-1}
    ({\bf P_O} - {\bf P_P})\right),
    % = \prod_i \frac{1}{\sqrt{2\pi}\sigma_i} \exp
    % \left(-\frac{(P_{\mathrm{obs}, i} - P_{\mathrm{pred},
    % i})^2}{2\sigma_i^2}\right),
\end{eqnarray}
% where $P_{\mathrm{obs}, i}$ is the $i$th observed rotation period,
% $P_{\mathrm{pred}, i}$ is the corresponding predicted rotation period,
% calculated from the $i$th age and $C_{B-V}$ values predicted by the isochronal
% model.
where ${\bf P_O}$ is a 1-D vector of observed logarithmic rotation periods,
and ${\bf P_P}$ is the vector of corresponding logarithmic rotation periods,
predicted by the model.
$\Sigma_P$ was comprised of individual rotation period measurement
% uncertainties, plus an additional variance that was a function of EEP and B-V
uncertainties, plus an additional variance that is a function of EEP and
\gcolor\
color, added in quadrature.
This variance accounts for the stochastic nature of the rotation periods of
very hot and very cool stars and allowed us to predominantly use isochrone
fitting to measure the ages of subgiants.
The full likelihood used in our model was the product of these two likelihood
functions,
% \begin{eqnarray} \label{eqn:full_likelihood} & \mathcal{L_{\mathrm{full}}} =
% \frac{1}{\sqrt{(2\pi)^n \det(\Sigma)}} \exp\left( -\frac{1}{2} [{\bf O_I} -
% {\bf I}]^T \Sigma ^{-1} [{\bf O_I} - {\bf I}]\right) \\ \nonumber & \times
% \frac{1}{\sqrt{(2\pi) \det(\Sigma_P)}} \exp\left( -\frac{1}{2} [{\bf P_O} -
% {\bf P_P}]^T \Sigma ^{-1} [{\bf P_O} - {\bf P_P}]\right).
% \end{eqnarray}
\begin{equation}
    \mathcal{L}_{\mathrm{full}} = \mathcal{L}_{\mathrm{iso}} \times
    \mathcal{L}_{\mathrm{gyro}}.
\end{equation}

% Practicalities: sampling, etc.
%-----------------------------------------------------------------------------
%%- isochrones.py
%To calculate ${\bf I}$, the vector of predicted isochronal observables, we
%used the {\tt isochrones.py} {\it python} package which has a range of
%functionalities relating to isochrone fitting.
%The first of the {\tt isochrones.py} functions we used is the likelihood
%function of equation \ref{eqn:isochrones_only_likelihood}.
%The {\tt isochrones.py} likelihood function accepts a dictionary of
%observables which can, but does not {\it have} to include, all of the
%following: \teff, \logg, $F$, parallax and apparent magnitudes in a range of
%colors, as well as the uncertainties on all these observables.
%It then calculates the residual vector $({\bf O_I} - {\bf I})$ where ${\bf
%O_I}$ is the vector of observables and ${\bf I}$ is a vector of corresponding
%predicted observables.
%The prediction is calculated using a set of isochrones \citep[we used the MIST
%models,][]{paxton2011, paxton2013, paxton2015, dotter2016, choi2016,
%paxton2018}, where the set of {\it model} observables that correspond to a set
%of physical parameters is returned.
%This requires interpolation over the model grids since, especially at high
%dimensions, it is unlikely that any set of physical parameters will exactly
%match a precomputed set of isochrones.
%The observables that correspond to a set of physical parameters go into ${\bf
%I}$ and the {\tt isochrones.py} likelihood function returns the result of
%equation \ref{eqn:isochrones_only_likelihood}.
%The second {\tt isochrones.py} function we used is one that predicts \cbv\ for
%a given set of stellar parameters, which was then used to calculate the
%gyrochronal likelihood function of equation \ref{eqn:gyro_likelihood}.

%   - Step-by-step description
The inference processes proceded as follows.
 % (as a reminder, we use {\it
% observables} to refer to the data: \teff, \logg, etc and {\it parameters} to
% refer to the model parameters: EEP, age, metallicity, distance and extinction.
First, a set of parameters: age, EEP, metallicity, distance and extinction,
and observables for a single star were passed to the isochronal likelihood
function in equation \eqref{eqn:isochrones_only_likelihood}.
Then, a set of observables corresponding to those parameters were generated
from the MIST model grid using {\tt isochrones.py} and compared to the
measured observables via the isochronal likelihood,
$\mathcal{L}_{\mathrm{iso}}$ (also computed using {\tt isochrones.py}.
The parameters were also passed to the gyrochronology model where $A$, $E$,
% $F$, $D$ and $A_V$ were used to calculate $B-V$ color and mass and, in turn,
$F$, $D$ and $A_V$ were used to calculate \gcolor\ color and mass from the
MIST model grid and, in turn, rotation period via the gyrochronology model.
% EEP and $B-V$ were also used to calculate the additional rotation period
EEP and \gcolor\ were also used to calculate the additional rotation period
variance, added to the individual period uncertainties.
This model rotation period was compared to the measured rotation period using
gyrochronal likelhood function of equation \ref{eqn:gyro_likelihood}.
The gyrochronal log-likelihood was added to the isochronal log-likelihood to
give the full likelihood, which was then added to the log-prior to produce a
single sample from the posterior PDF.

% % PIXIE
% %   - The gyrochronology models
% We used the following gyrochronology model to infer ages from rotation
% periods,
% \begin{equation}
%     \log_{10}(P_\mathrm{rot}) \sim \begin{cases}
%         \mathcal{N}(\log_{10}(\alpha) + \eta \log_{10}(A) + \beta \log_{10}[B-V
%         - \delta], [\sigma_P+f(E, B-V)^2]), & Ro < 2 \\
%         \mathcal{N}(\log_{10}(P_\mathrm{max}), [\sigma_P+f(E, G_{BP} -
%         G_{RP})^2]),& Ro \geq 2 \\
%         \mathcal{N}(\log_{10}(P_\mathrm{max}), [\sigma_P+f(E, G_{BP} - G_{RP})^2]),& Ro \geq 2 \\
%         \mathcal{N}(0, [\sigma_P+f(E, B-V)^2]),& B-V < 0.45,
%     \end{cases}
% \label{eqn:gyro}
% \end{equation}
% where \prot\ is rotation period in days, $B-V$ is a star's color,
% $A$ is stellar age in Myrs, $\sigma_P$ is the logarithmic measured period
% uncertainty and $\eta$, $\alpha$, $\beta$ and $\delta$ took values 0.55,
% 0.4, 0.31 and 0.45 respectively \citep{angus2015}.
% Rotation periods were described as a normal distribution with a power law mean
% function for early F and GKM stars with $Ro < 2$, and a constant mean value
% for stars with $Ro > 2$ or stars hotter than 0.45 in $B-V$.

%   - Emcee, including assessing convergence.
Ages were inferred with \sd\ using Markov Chain Monte Carlo.
The joint posterior PDF over age, mass, metallicity, distance and extinction
was sampled using the affine invariant ensemble sampler, {\tt emcee}
\citep{foreman-mackey2013} with 24 walkers.
Samples were drawn from the posterior PDF until 100 {\it independent} samples
were obtained.
We actively estimated the autocorrelation length, which indicates how many
steps were taken per independent sample, after every 100 steps using the
autocorrelation tool built into {\tt emcee}.
The MCMC concluded when {\it either} 100 times the autocorrelation length was
reached and the change in autocorrelation length over 100 samples was less
than 0.01, {\it or} the maximum of 100,000 samples was obtained.
This method is trivially parallelizable, since the inference process for each
star can be performed on a separate core.
The age of a single star can be inferred in around 10 minutes on a laptop
computer.

% Although the gyrochronology model described above \citep[equation
% \ref{eqn:gyro},][]{angus2015} has been calibrated using a number of cluster
% stars, it does not provide a good fit to any individual cluster.
% No current gyrochronology model is able to capture the behavior of rotation as
% a function of color and age for individual benchmark clusters: the shape of
% this relation is different in each and current models are not flexible enough
% to capture inter-cluster differences in rotational evolution.
% For this reason, we also explored the rotational evolution of a single
% cluster, in order to produce a best-case model and demonstrate the potential
% of rotation-dating in a case where the model is perfectly accurate.
% We chose Praesepe as it is a relatively old open cluster \citep[$\sim$ 600
% Myrs][]{gossage2018}, meaning its Solar-type members have converged onto the
% rotational main sequence, and it is relatively compact on the sky so many of
% its members were observed during a single \ktwo\ campaign.
% In fact, Praesepe was repeatedly observed by \ktwo, in Campaigns 5, 16 and 18,
% however we only use rotation periods published from the analysis of Campaign 5
% in this work \citep{rebull2016}.

% % The Praesepe model
% We used a three-dimensional polynomial model to predict rotation period as a
% function of \gaia\ color and age for Praesepe and the Sun.
% This model consists of a 4th order polynomial in logarithmic Gaia color:
% $G_{Bp} - G_{Rp}$, which we write as $C_G$ for simplicity, and a 1st order
% polynomial (a straight line) in logarithmic age.
% We used \gcolor\ instead of (B-V) because, due to the $\sim$ billion stars
% observed by \gaia, it is now the most abundant and widely available
% photometric color.
% Our gyrochronology likelihood function is designed to compare observed
% rotation period to predicted rotation period.
% For this reason the gyrochronology model we used must predict rotation period
% as a function of age and color.
% However, when {\it calibrating} the gyrochronology model, we chose to make
% {\it age} the dependent variable because the uncertainties on age are much
% greater than the uncertainties on rotation period.
% Since we are using a linear model, the relation is easily invertable.
% We fit the following model to Praesepe members:
% \begin{equation}
%     \log_{10}(A) = a + b\log_{10}(C_G) + c\log_{10}^2(C_G) +
%     d\log_{10}^3(C_G) + e\log_{10}^4(C_G) + f\log_{10}(P)
% \label{eqn:gyro_age_praesepe}
% \end{equation}
% where $P$ is rotation period in days, $C_G$ is Gaia color, $A$ is stellar age
% in years and the lower case letters are free parameters which we fitted to the
% data using linear least squares.
% We adopted an age for Praesepe of 600 million years \citep{gossage2018}, a
% Solar age of 4.56 Gyr \citep{connelly2012}, and a Solar rotation period of 26
% days \citep[][Morris \etal, in prep]{balthasar1986, howe2000}.
% The Sun's color in the Gaia color bandpasses, $G_{Bp} - G_{Rp}$, is 0.82
% \citep{casagrande2018}.
% We found best-fit values: $a = 7.37 \pm 0.03, b = -1.4 \pm 0.1, c = 5.0 \pm
% 0.8, d = -34 \pm 3, e = 66 \pm 14$, and $f = 1.49 \pm 0.02$.
% Rotation periods for Prasepe were obtained from \citet{rebull2017} and their
% \gaia\ colors were obtained by crossmatching their sky-projected positions
% with the \gaia\ DR2 catalog.
% % The $f$ parameter is the inverse of the slope of the rotation period and age
% % which was originally measured to be around 0.5.
% % Our Praesepe and Sun-only fit results in a slightly steeper age dependence of
% % around 0.67, however this value is likely be
% We inverted this relation to predict rotation period as a function of color
% and age,
% \begin{equation}
%     \log_{10}(P) = \frac{\log_{10}(A) - a - b\log_{10}(C_G) - c\log_{10}^2(C_G) -
%     d\log_{10}^3(C_G) - e\log_{10}^4(C_G)}{f}.
% \label{eqn:gyro_age_praesepe}
% \end{equation}
% Both gyrochronology models of equations \ref{eqn:gyro} and
% \ref{eqn:gyro_age_praesepe} are used to predict the ages of individual
% Praesepe stars from their rotation periods and apparent magnitudes in section
% \ref{section:results}.

% % The PGM
% \begin{figure}
%   \caption{
% A probabilistic graphical model (PGM) showing the conditional
% dependencies between the parameters (white nodes) and
% observables (gray nodes) in our model.
% % ${\bf \theta}$ is a vector of {\it parameters}: mass, observed bulk
% %     metallicity, distance and V-band extinction; and ${\bf O}$ is a vector of
% %     {\it observables}: apparent magnitudes, $m_x$, effective temperature,
% %     \teff, surface gravity, \logg, observed bulk metallicity, $\hat{F}$, and
% %     parallax, $\bar{\omega}$.
% % determined by the mass, $M$, age, $A$, distance, $D$, extinction, $A_V$
% % and bulk metallicity, $F$, of a star.
% ${\bf \theta}$ is a vector of {\it parameters}: mass, observed bulk
%     metallicity, distance and V-band extinction; and ${\bf O}$ is a vector of
%     {\it observables}: apparent magnitudes, effective temperature, surface
%     gravity, observed bulk metallicity, and parallax.
%     The observables, ${\bf O}$, are determined by the parameters, $A$ and
%     ${\bf \theta}$.
%     $C_{B-V}$ is a latent parameter that is also determined by the parameters
%     $A$ and ${\bf \theta}$.
%     In our model, the rotation period observable, $P$, is determined {\it
%     only} by the age, $A$, and color ${C_{B-V}}$ parameters.
% The dependencies of observables on parameters and parameters on parameters are
%     indicated by arrows that start at a `parent' node and end at the dependent
%     observable, or `child' node.
% In our model, rotation period does not directly depend on distance,
% extinction, metallicity or mass, only age and B-V color.
% This PGM is a representation of the factorized joint PDF over parameters and
% observables of equation \ref{eqn:factorized}.
% }
%   \centering
%     \includegraphics[width=.7\textwidth]{PGM}
% \label{fig:PGM}
% \end{figure}
